{% extends "base.html" %}

{% block content %}
<div style="padding: 2rem 5%;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1><span data-i18n="welcome">Welcome</span>, {{ user.name }}</h1>
        <button onclick="toggleModal('grievance-modal')" class="btn btn-primary"><i class="fas fa-plus"></i> <span
                data-i18n="btn_file">File a Grievance</span></button>
    </div>

    <div class="glass-card">
        <h3 data-i18n="recent_grievances">Your Recent Grievances</h3>
        <!-- Existing Table Code... -->
        <div style="overflow-x: auto; margin-top:20px;">
            <table style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align:left; border-bottom:2px solid #eee;">
                        <th style="padding:10px;" data-i18n="id">ID</th>
                        <th data-i18n="sector">Sector</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="date">Date</th>
                        <th data-i18n="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in complaints %}
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;">{{ c.complaint_id }}</td>
                        <td><span data-i18n="{{ c.sector.lower().replace('&', '').replace(' ', '') }}">{{ c.sector
                                }}</span></td>
                        <td><span class="status-badge {{ c.status.lower().replace(' ', '-') }}"
                                data-i18n="status_{{ c.status.lower().replace(' ', '') }}">{{ c.status }}</span></td>
                        <td>{{ c.created_at.strftime('%Y-%m-%d') }}</td>
                        <td><button onclick="viewComplaint('{{ c.complaint_id }}')" class="btn"
                                style="border:1px solid var(--primary); padding:5px 15px;"
                                data-i18n="view">View</button></td>
                    </tr>
                    {% endfor %}
                    {% if not complaints %}
                    <tr>
                        <td colspan="5" style="text-align:center; padding:20px;" data-i18n="no_grievances">No grievances
                            found.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button onclick="togglePublicFeed()" class="btn btn-secondary">
                <i class="fas fa-users"></i> <span data-i18n="view_community">View Community Grievances (Grouped by
                    Pincode)</span>
            </button>
        </div>
    </div>

    <!-- Public Feed Container -->
    <div id="public-feed" style="display:none; margin-top:30px;">
        <h2 style="margin-bottom:20px; color:var(--primary);" data-i18n="community_complaints">Community Complaints</h2>
        <div id="pincode-groups">
            <!-- Dynamic Content -->
        </div>
    </div>
</div>

<!-- Grievance Form Modal -->
<div id="grievance-modal" class="modal">
    <div class="modal-content" style="width: 70%; max-height: 90vh; overflow-y: auto;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 data-i18n="register_new">Register New Grievance</h2>
            <span onclick="toggleModal('grievance-modal')" style="cursor:pointer; font-size:2rem;">&times;</span>
        </div>

        <form id="grievance-form" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="form-group">
                <label data-i18n="name">Name</label>
                <input type="text" name="name" value="{{ user.name }}" required>
            </div>
            <div class="form-group">
                <label data-i18n="mobile_number">Mobile Number</label>
                <div style="display:flex; gap:10px;">
                    <input type="tel" name="phone" id="phone_input" value="{{ user.phone }}" required>
                    <button type="button" onclick="verifyPhone()" class="btn btn-secondary" style="padding:0 10px;"
                        data-i18n="verify">Verify</button>
                </div>
            </div>
            <div class="form-group">
                <label data-i18n="aadhaar">Aadhaar Number</label>
                <input type="text" name="aadhaar" placeholder="12-digit Aadhaar" required maxlength="12">
            </div>
            <div class="form-group">
                <label data-i18n="pincode">Pincode</label>
                <input type="text" name="pincode" placeholder="e.g. 600001" required>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label data-i18n="full_address">Full Address</label>
                <div style="position:relative;">
                    <textarea id="address" name="address" rows="2" required></textarea>
                    <button type="button" onclick="startSpeechRecognition('address')"
                        style="position:absolute; right:10px; bottom:10px; background:none; border:none; font-size:1.5rem; color:var(--primary); cursor:pointer;">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label data-i18n="description_label">Grievance Description (Speak or Type)</label>
                <div style="position:relative;">
                    <textarea id="description" name="description" rows="4" placeholder="Describe your issue here..."
                        required onkeyup="analyzeText(this.value)" data-i18n="description_placeholder"></textarea>
                    <button type="button" onclick="startSpeechRecognition('description')"
                        style="position:absolute; right:10px; bottom:10px; background:none; border:none; font-size:1.5rem; color:var(--primary); cursor:pointer;">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <div id="detected-priority" style="margin-top:10px; font-weight:bold;"></div>
            </div>

            <div class="form-group" style="grid-column: span 2;">
                <label data-i18n="select_sector">Select Sector</label>
                <div class="sector-grid">
                    <div class="sector-item" data-sector="Roads" onclick="selectSector('Roads')"><i
                            class="fas fa-road"></i><br><span data-i18n="roads">Roads</span></div>
                    <div class="sector-item" data-sector="Electricity" onclick="selectSector('Electricity')"><i
                            class="fas fa-bolt"></i><br><span data-i18n="electricity">Electricity</span></div>
                    <div class="sector-item" data-sector="Water" onclick="selectSector('Water')"><i
                            class="fas fa-faucet"></i><br><span data-i18n="water">Water</span></div>
                    <div class="sector-item" data-sector="Health" onclick="selectSector('Health')"><i
                            class="fas fa-hospital"></i><br><span data-i18n="health">Health</span></div>
                    <div class="sector-item" data-sector="Education" onclick="selectSector('Education')"><i
                            class="fas fa-book-reader"></i><br><span data-i18n="education">Education</span></div>
                    <div class="sector-item" data-sector="Welfare" onclick="selectSector('Welfare')"><i
                            class="fas fa-hands-helping"></i><br><span data-i18n="welfare">Welfare</span></div>
                    <div class="sector-item" data-sector="Law & Order" onclick="selectSector('Law & Order')"><i
                            class="fas fa-balance-scale"></i><br><span data-i18n="law_order">Law & Order</span></div>
                </div>
            </div>

            <div class="form-group" style="grid-column: span 2;">
                <label data-i18n="upload_doc">Upload Document (Image/PDF)</label>
                <input type="file" name="evidence">
            </div>

            <div
                style="grid-column: span 2; display:flex; gap:20px; justify-content: flex-end; position: sticky; bottom: -21px; background: white; padding: 20px; border-top: 1px solid #eee; margin: 0 -20px -20px -20px; z-index:100;">
                <button type="button" onclick="toggleModal('grievance-modal')" class="btn btn-secondary"
                    data-i18n="cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" style="box-shadow: 0 4px 14px 0 rgba(0,118,255,0.39);"
                    data-i18n="submit_grievance">Submit Grievance</button>
            </div>
        </form>
    </div>
</div>

<script>
    let selectedSector = "";
    function selectSector(sector) {
        selectedSector = sector;
        document.querySelectorAll('.sector-item').forEach(item => {
            item.classList.toggle('active', item.dataset.sector === sector);
        });
    }

    async function verifyPhone() {
        const phone = document.getElementById('phone_input').value;
        if (!phone) {
            alert("Please enter a phone number");
            return;
        }

        const btn = document.querySelector('[data-i18n="verify"]');
        const originalText = btn.innerText;
        btn.innerText = "Sending...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/verify-phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: phone })
            });
            const data = await res.json();

            if (data.success) {
                alert(data.message);
                btn.innerText = "Sent!";
            } else {
                alert("Error: " + data.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Failed to send verification SMS");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    document.getElementById('grievance-form').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        if (selectedSector) formData.append('target_sector', selectedSector);

        const res = await fetch('/api/submit-grievance', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        if (data.success) {
            // Show ID clearly
            prompt("Grievance Registered Successfully! Please save your Complaint ID:", data.complaint_id);
            location.reload();
        }
    };

    function viewComplaint(id) {
        // Mocking for now
        alert("Fetching details for " + id);
    }

    async function togglePublicFeed() {
        const feed = document.getElementById('public-feed');
        if (feed.style.display === 'none') {
            feed.style.display = 'block';

            // Show loading state
            document.getElementById('pincode-groups').innerHTML = '<p style="text-align:center;">Loading community data...</p>';

            try {
                const res = await fetch('/api/public-grievances');
                const result = await res.json();

                if (result.success) {
                    renderPublicFeed(result.data);
                }
            } catch (e) {
                console.error(e);
                document.getElementById('pincode-groups').innerHTML = '<p style="text-align:center; color:red;">Failed to load data.</p>';
            }
        } else {
            feed.style.display = 'none';
        }
    }

    function renderPublicFeed(groupedData) {
        const container = document.getElementById('pincode-groups');
        container.innerHTML = '';

        const pincodes = Object.keys(groupedData).sort();

        // Get current language and translations
        const lang = currentLang || 'en';
        const t = translations[lang] || translations['en'];

        if (pincodes.length === 0) {
            container.innerHTML = `<p style="text-align:center;">${t['no_grievances'] || 'No public grievances found.'}</p>`;
            return;
        }

        for (const pin of pincodes) {
            const items = groupedData[pin];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'glass-card';
            groupDiv.style.marginBottom = '20px';
            groupDiv.style.padding = '0'; // Custom padding management

            groupDiv.innerHTML = `
                <div style="background:var(--secondary); color:white; padding:15px; border-radius:10px 10px 0 0; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size:1.2rem;"><i class="fas fa-map-marker-alt"></i> ${t['pincode'] || 'Pincode'}: ${pin}</h3>
                    <span style="background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px; font-weight:bold;">${items.length} ${t['issues'] || 'Issues'}</span>
                </div>
                <div style="padding:20px;">
                    <ul style="list-style:none; padding:0; margin:0;">
                         ${items.map(item => {
                // Translate sector
                const sectorKey = item.sector.toLowerCase().replace(/\s+/g, '').replace(/&/g, '');
                const translatedSector = t[sectorKey] || item.sector;

                // Translate status
                const statusKey = 'status_' + item.status.toLowerCase().replace(/\s+/g, '');
                const translatedStatus = t[statusKey] || item.status;

                return `
                             <li style="border-bottom:1px solid #eee; padding:15px 0; first-child:padding-top:0;">
                                 <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                     <span style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${translatedSector}</span>
                                     <span class="status-badge ${item.status.toLowerCase().replace(/ /g, '-')}" style="background:#eee; color:#333; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${translatedStatus}</span>
                                 </div>
                                 <p style="margin:5px 0 10px 0; color:#444; line-height:1.5;">${item.description}</p>
                                 <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#888;">
                                     <span>${t['id'] || 'ID'}: <strong>${item.id}</strong></span>
                                     <span>${item.date}</span>
                                 </div>
                             </li>
                         `;
            }).join('')}
                    </ul>
                </div>
            `;
            container.appendChild(groupDiv);
        }
    }
</script>

<style>
    .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .submitted {
        background: #e3f2fd;
        color: #1976d2;
    }

    .assigned {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .in-progress {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .resolved {
        background: #fffde7;
        color: #fbc02d;
    }

    .priority-badge.high {
        color: #d32f2f;
        background: #ffebee;
    }

    .priority-badge.medium {
        color: #f57c00;
        background: #fff3e0;
    }

    .priority-badge.low {
        color: #388e3c;
        background: #e8f5e9;
    }
</style>
{% endblock %}