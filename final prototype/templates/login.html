{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
    <div class="glass-card" style="width: 400px;">
        <h2 style="text-align: center; margin-bottom: 25px;" data-i18n="citizen_login">Citizen Login</h2>
        <div class="form-group">
            <label data-i18n="email_address">Email Address</label>
            <input type="email" id="email" placeholder="email@example.com">
        </div>
        <div class="form-group">
            <label data-i18n="password">Password</label>
            <input type="password" id="password" placeholder="••••••••">
        </div>

        <div class="form-group">
            <label><span data-i18n="security_captcha">Security Captcha:</span> <span id="captcha-text">5 + 3 =
                    ?</span></label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="captcha-input" placeholder="Enter characters" style="text-transform: uppercase;">
                <button onclick="speakCaptcha()" class="btn" style="border:1px solid #ccc;"><i
                        class="fas fa-volume-up"></i></button>
                <button onclick="generateCaptcha()" class="btn" style="border:1px solid #ccc;"><i
                        class="fas fa-sync"></i></button>
            </div>
        </div>

        <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%; margin-top: 15px;"
            data-i18n="login">Login</button>
        <p style="text-align: center; margin-top: 15px;">
            <span data-i18n="new_user">New user?</span> <a href="/signup" data-i18n="signup_here">Sign Up here</a>
        </p>
    </div>
</div>

<script>
    let captchaRes = "";
    function generateCaptcha() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let result = "";
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        captchaRes = result;
        const displayDiv = document.getElementById('captcha-text');
        displayDiv.innerText = result.split('').join(' ');
        displayDiv.style.fontFamily = 'monospace';
        displayDiv.style.letterSpacing = '5px';
        displayDiv.style.fontWeight = 'bold';
        displayDiv.style.background = '#eee';
        displayDiv.style.padding = '2px 10px';
        displayDiv.style.borderRadius = '5px';
    }

    function speakCaptcha() {
        // Read out characters individually
        const textToSpeak = captchaRes.split('').join(' ');
        speak(`Please type the following characters: ${textToSpeak}`);
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const captcha = document.getElementById('captcha-input').value;

        if (captcha.toUpperCase().replace(/\s/g, '') !== captchaRes) {
            alert("Incorrect captcha!");
            generateCaptcha();
            return;
        }

        const res = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = data.role === 'admin' ? '/admin-dashboard' : '/dashboard';
        } else {
            alert(data.message);
        }
    }

    generateCaptcha();
</script>
{% endblock %}